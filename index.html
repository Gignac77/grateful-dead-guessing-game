<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DeadGuessr</title>
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Comic Neue', cursive;
      text-align: center;
      padding: 2em;
      background: url('https://cdn.mos.cms.futurecdn.net/HuGGeENt6kGyixe3hT9tnY.jpg');
      background-color: #111;
      color: #eee;
      margin: 0;
    }
    .card {
      background: rgba(0, 0, 0, 0.85);
      padding: 2em;
      border-radius: 1em;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      max-width: 600px;
      margin: auto;
      width: 90%;
      position: relative;
    }
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }
    .header-container h1 {
        font-size: clamp(2.4em, 10vw, 3.8em);
        color: yellow;
        margin: 0;
        font-weight: 900;
        flex-grow: 1;
    }
    /* Bolding the title */
    .header-container h1 strong {
        font-weight: bold;
    }
    .header-container span {
        font-size: 2.2em;
        color: #228B22;
    }
    audio {
      width: 100%;
      margin: 1em 0;
      border: none;
    }
    button {
      padding: 0.6em 1.2em;
      font-size: 1.2em;
      color: white;
      border: none;
      border-radius: 0.5em;
      margin-top: 1em;
      cursor: pointer;
      font-family: 'Comic Neue', cursive;
      font-weight: bold;
      transition: background-color 0.3s, opacity 0.3s;
    }
    button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    .generate {
      background-color: #28a745;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      font-size: 1.2em;
      animation: pulse 1.5s infinite;
    }
    .reveal {
      background-color: #0066cc;
    }
    .timed {
      background-color: #9933cc;
      font-size: 1em;
      padding: 0.4em 1em;
      opacity: 0.6;
    }
    .timed.active {
      opacity: 1;
    }
    .donate {
      display: inline-block;
      margin-top: 2em;
      background-color: #d63384;
      color: yellow;
      text-decoration: none;
      font-weight: bold;
      font-size: 1em;
      padding: 0.5em 1.5em;
      border-radius: 0.5em;
      font-family: 'Comic Neue', cursive;
    }
    .share {
      display: inline-block;
      margin-top: 1em;
      background-color: #4444aa;
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 0.9em;
      padding: 0.4em 1em;
      border-radius: 0.5em;
      font-family: 'Comic Neue', cursive;
    }
    input {
      font-size: 1em;
      padding: 0.5em;
      border-radius: 0.3em;
      border: 1px solid #ccc;
      margin-top: 1em;
      background-color: white;
      color: black;
      text-align: center;
      font-weight: bold;
      width: 6em;
      font-family: 'Comic Neue', cursive;
    }
    #result {
      margin-top: 1em;
      font-weight: bold;
      font-size: 1.5em;
      white-space: pre-line;
      min-height: 3em;
    }
    .correct {
      color: #00ff88;
      animation: glow 1.5s ease-out;
    }
    .incorrect {
      color: #ff4444;
    }
    .neutral {
      color: yellow;
    }
    #score {
      margin-top: 1em;
      font-size: 1.2em;
      color: #fff;
      background-color: rgba(255,255,255,0.1);
      border: 1px solid #eee;
      padding: 1em;
      border-radius: 1em;
    }
    #thankYou {
      margin-top: 0.5em;
      color: white;
      font-style: italic;
    }
    #timerBar {
      width: 100%;
      height: 10px;
      background: linear-gradient(to right, #00ff88, #ff0000);
      transition: width 1s linear;
      margin-top: 1em;
      border-radius: 1em;
      display: none;
    }
    @keyframes glow {
      0% { text-shadow: 0 0 5px #00ff88; }
      50% { text-shadow: 0 0 20px #00ff88; }
      100% { text-shadow: 0 0 5px #00ff88; }
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
      100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
    select {
      margin-top: 1em;
      padding: 0.4em;
      font-size: 1em;
      font-family: 'Comic Neue', cursive;
    }
    #gameModeIndicator {
        font-size: 1.1em;
        margin-top: 1em;
        color: #ffc107;
        font-weight: bold;
    }
    #dailySummaryModal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7);
        backdrop-filter: blur(5px);
    }
    .modal-content {
        background-color: #1a1a1a;
        margin: 10% auto;
        padding: 25px;
        border: 1px solid #888;
        width: 90%;
        max-width: 500px;
        border-radius: 1em;
        text-align: center;
        color: #fff;
    }
    #summaryGraphic {
        font-size: 2em;
        letter-spacing: 0.2em;
        margin: 1em 0;
    }
    #summaryDetails {
        text-align: left;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
        padding-right: 10px;
        margin-bottom: 1.5em;
    }
    .modal-button {
        background-color: #17a2b8;
    }
    .modal-button.continue {
        background-color: #28a745;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header-container">
      <span>⚡💀</span>
      <h1><strong>DeadGuessr</strong></h1>
      <span>💀⚡</span>
    </div>
    <p style="font-style: italic; margin-top: 0.5em; font-size: 0.9em;">1965–1995</p>

    <br />
    <audio id="audio" controls></audio>
    <br />

    <button id="goButton" class="generate" onclick="loadTrack()">Go</button>
    <br />

    <input type="text" id="yearGuess" placeholder="Year" maxlength="4" autocomplete="off" />
    <br />

    <button id="checkButton" class="reveal" onclick="revealAnswer()">Check Answer</button>
    <br />
    <button class="timed" onclick="toggleTimedMode(this)">Timed Mode</button>

    <div id="timerBar"></div>
    
    <div id="gameModeIndicator"></div>

    <select id="decadeSelect" onchange="filterByDecade(this.value)">
      <option value="">All Decades</option>
      <option value="196">1960s</option>
      <option value="197">1970s</option>
      <option value="198">1980s</option>
      <option value="199">1990s</option>
    </select>

    <p id="result" class="neutral"></p>
    <p id="score">Session Score: 0/0 | High Score: 0 | Streak: 0</p>

    <a href="https://www.gofundme.com/f/our-friend-betty-cantorjackson-could-use-our-help" target="_blank" class="donate">🌸 Donate to Betty</a>
    <br />
    <a class="share" href="#" onclick="copyShareLink(event, false)">🔗 Share This Game</a>
    <p id="thankYou">Thank a Taper</p>
  </div>

  <div id="dailySummaryModal">
    <div class="modal-content">
      <h2>Daily Results <span id="summaryDate" style="color: #ffc107;"></span></h2>
      <div id="summaryGraphic"></div>
      <div id="summaryDetails"></div>
      <button class="modal-button" onclick="copyShareLink(event, true)">Share Your Results</button>
      <button class="modal-button continue" onclick="closeSummaryModal()">Continue to Free Play</button>
    </div>
  </div>

<script>
let currentTrack = null;
let totalAttempts = 0;
let correctAttempts = 0;
let streak = 0;
let siteHighScore = parseInt(localStorage.getItem('gd_site_highscore')) || 0;
let allTracks = [];
let filteredTracks = [];
let availableTracksForSession = []; // For free play
let timedMode = false;
let timer = null;
let timeLeft = 20;
let answerRevealed = false;

// --- NEW LOGIC FOR DAILY ROTATION ---
const MAX_DAILY_GUESSES = 5;
let dailyGuesses = 0;
let dailyResults = [];
let todaysDailySongs = []; // Holds the 5 fixed songs for the day
let inFreePlayMode = false;

document.addEventListener('DOMContentLoaded', async () => {
    await loadTracksJson(); // Load all tracks first
    checkDailyStatus(); // Determine game mode and today's 5 songs
    
    if (!inFreePlayMode) {
        document.getElementById('result').textContent = 'Press "Go" to start your Daily Challenge!';
    } else {
        document.getElementById('result').textContent = 'Daily Challenge complete! Welcome to Free Play.';
    }
});

function getTodayString() {
    // Use UTC date to ensure everyone gets the same songs on the same day
    return new Date().toISOString().split('T')[0];
}

/**
 * Manages the daily song queue and user progress.
 */
function checkDailyStatus() {
    const lastPlayDate = localStorage.getItem('gd_lastPlayDate');
    const today = getTodayString();

    // This function now also sets the `todaysDailySongs` array
    setDailySongs(); 

    if (lastPlayDate === today) {
        // User has played today, load their progress
        dailyGuesses = parseInt(localStorage.getItem('gd_dailyGuesses')) || 0;
        dailyResults = JSON.parse(localStorage.getItem('gd_dailyResults')) || [];
        if (dailyGuesses >= MAX_DAILY_GUESSES) {
            inFreePlayMode = true;
        }
    } else {
        // New day, reset user's daily progress
        localStorage.setItem('gd_lastPlayDate', today);
        localStorage.setItem('gd_dailyGuesses', '0');
        localStorage.setItem('gd_dailyResults', '[]');
        dailyGuesses = 0;
        dailyResults = [];
        inFreePlayMode = false;
    }
    updateGameModeUI();
}

/**
 * Creates and manages the persistent, shuffled master playlist for daily challenges.
 */
function setDailySongs() {
    let queue = JSON.parse(localStorage.getItem('gd_dailySongQueue'));
    let index = parseInt(localStorage.getItem('gd_dailyQueueIndex')) || 0;

    // If queue doesn't exist or is empty, create it
    if (!queue || queue.length === 0) {
        queue = [...allTracks];
        // Shuffle using Fisher-Yates algorithm
        for (let i = queue.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [queue[i], queue[j]] = [queue[j], queue[i]];
        }
        localStorage.setItem('gd_dailySongQueue', JSON.stringify(queue));
        index = 0; // Start from the beginning
    }

    // If index is out of bounds, reset and re-shuffle
    if (index >= queue.length) {
        index = 0;
        // Optional: Re-shuffle here if you want a new order each cycle
        localStorage.setItem('gd_dailySongQueue', JSON.stringify(queue.sort(() => Math.random() - 0.5)));
    }

    todaysDailySongs = queue.slice(index, index + MAX_DAILY_GUESSES);

    // This part should only advance the index ONCE per day.
    // We check if the last advance date is today.
    const lastAdvanceDate = localStorage.getItem('gd_lastQueueAdvanceDate');
    if(lastAdvanceDate !== getTodayString()) {
        localStorage.setItem('gd_dailyQueueIndex', (index + MAX_DAILY_GUESSES).toString());
        localStorage.setItem('gd_lastQueueAdvanceDate', getTodayString());
    }
}

function updateGameModeUI() {
    const indicator = document.getElementById('gameModeIndicator');
    if (inFreePlayMode) {
        indicator.textContent = 'Mode: Free Play';
    } else {
        const guessesLeft = MAX_DAILY_GUESSES - dailyGuesses;
        indicator.textContent = `Daily Challenge: ${guessesLeft}/${MAX_DAILY_GUESSES} Guesses Left`;
    }
}

async function loadTracksJson() {
  try {
    const res = await fetch('tracks.json');
    allTracks = await res.json();
    // Initialize free play tracks immediately
    availableTracksForSession = [...allTracks];
  } catch {
    document.getElementById('result').textContent = 'Could not load tracks. Please refresh!';
  }
}

/**
 * A single function to load the correct track based on game mode.
 */
function loadTrack() {
    let track;
    if (!inFreePlayMode) {
        // Daily Challenge: Load the next song from the fixed daily list
        if (dailyGuesses < MAX_DAILY_GUESSES) {
            track = todaysDailySongs[dailyGuesses];
        } else {
            // Should not happen, but as a fallback...
            inFreePlayMode = true;
            updateGameModeUI();
            alert("Daily challenge finished! Entering Free Play.");
            return;
        }
    } else {
        // Free Play: Load a random track
        if (availableTracksForSession.length === 0) {
            availableTracksForSession = [...allTracks]; // Re-populate
            alert("You've played all the songs! Starting a new random cycle.");
        }
        const randIndex = Math.floor(Math.random() * availableTracksForSession.length);
        track = availableTracksForSession[randIndex];
        availableTracksForSession.splice(randIndex, 1); // Remove to avoid repeats in session
    }

    if (!track) {
        document.getElementById('result').textContent = 'No more tracks available for today!';
        return;
    }
    
    currentTrack = track;
    answerRevealed = false;
    document.getElementById('audio').src = `audio/${track.filename}`;
    document.getElementById('audio').load();
    document.getElementById('audio').play().catch(() => {});
    document.getElementById('result').textContent = '';
    document.getElementById('result').className = 'neutral';
    document.getElementById('yearGuess').value = '';
    document.getElementById('checkButton').disabled = false;

    if (timedMode) startTimer();
}

function revealAnswer() {
  if (!currentTrack || answerRevealed) return;
  answerRevealed = true;
  clearInterval(timer);
  document.getElementById('timerBar').style.display = 'none';
  document.getElementById('checkButton').disabled = true;

  let guess = document.getElementById('yearGuess').value.trim();
  if (/^\d{2}$/.test(guess)) {
      guess = (parseInt(guess, 10) >= 65 ? '19' : '20') + guess;
  }

  const correctYear = currentTrack.year;
  const correct = (guess === correctYear);

  totalAttempts++;
  if (correct) {
      correctAttempts++;
      streak++;
  } else {
      streak = 0;
  }

  if (!inFreePlayMode) {
      dailyResults.push({
          correct: correct,
          guess: guess,
          trackInfo: `${currentTrack.track} (${correctYear})`
      });
      // Important: We only increment dailyGuesses AFTER revealing the answer for the current track.
      dailyGuesses++;
      localStorage.setItem('gd_dailyGuesses', dailyGuesses.toString());
      localStorage.setItem('gd_dailyResults', JSON.stringify(dailyResults));

      if (dailyGuesses >= MAX_DAILY_GUESSES) {
          showDailySummary();
      }
  }

  if (correctAttempts > siteHighScore) {
    siteHighScore = correctAttempts;
    localStorage.setItem('gd_site_highscore', siteHighScore);
  }

  const resultEl = document.getElementById('result');
  resultEl.className = correct ? 'correct' : 'incorrect';
  resultEl.textContent = `${correct ? 'Correct!' : 'Not Quite!'}\nYou guessed: ${guess} — Correct Year: ${correctYear}\n\nSong: ${currentTrack.track}\nDate: ${currentTrack.date}\n${currentTrack.venue}, ${currentTrack.location}`;
  
  updateScore();
  updateGameModeUI();
}

function showDailySummary() {
    const modal = document.getElementById('dailySummaryModal');
    document.getElementById('summaryDate').textContent = `(${getTodayString()})`;
    const graphicEl = document.getElementById('summaryGraphic');
    const detailsEl = document.getElementById('summaryDetails');
    
    let graphic = dailyResults.map(r => r.correct ? '🟩' : '🟥').join(' ');
    let details = dailyResults.map((result, index) => 
        `${result.correct ? '✅' : '❌'} Guess ${index + 1}: You guessed ${result.guess || 'none'} for ${result.trackInfo}`
    ).join('\n');
    let dailyCorrect = dailyResults.filter(r => r.correct).length;

    graphicEl.textContent = graphic;
    detailsEl.innerHTML = `<strong>Your Score Today: ${dailyCorrect}/${MAX_DAILY_GUESSES}</strong>\n\n${details}`;
    modal.style.display = 'block';
}

function closeSummaryModal() {
    document.getElementById('dailySummaryModal').style.display = 'none';
    inFreePlayMode = true;
    updateGameModeUI();
    document.getElementById('result').textContent = 'Welcome to Free Play! Press "Go" for a random song.';
}

function copyShareLink(event, isFromResultModal) {
  event.preventDefault();
  let shareText;
  if (isFromResultModal && dailyResults.length > 0) {
      const graphic = dailyResults.map(r => r.correct ? '🟩' : '🟥').join('');
      const dailyCorrect = dailyResults.filter(r => r.correct).length;
      shareText = `DeadGuessr ${getTodayString()}\nMy Score: ${dailyCorrect}/${MAX_DAILY_GUESSES}\n${graphic}\n\nPlay here: ${window.location.href}`;
  } else {
      shareText = `Check out this "DeadGuessr" game! \n\n${window.location.href}`;
  }

  navigator.clipboard.writeText(shareText).then(() => {
    alert('Results copied to clipboard!');
  }).catch(err => console.error('Failed to copy: ', err));
}

function updateScore() {
  document.getElementById('score').textContent = `Session Score: ${correctAttempts}/${totalAttempts} | High Score: ${siteHighScore} | Streak: ${streak}`;
}

function toggleTimedMode(btn) {
  timedMode = !timedMode;
  btn.classList.toggle('active', timedMode);
  if (!timedMode) {
    clearInterval(timer);
    document.getElementById('timerBar').style.display = 'none';
  }
}

function startTimer() {
  clearInterval(timer);
  timeLeft = 20;
  const bar = document.getElementById('timerBar');
  bar.style.display = 'block';
  bar.style.width = '100%';

  timer = setInterval(() => {
    timeLeft--;
    bar.style.width = `${(timeLeft / 20) * 100}%`;
    if (timeLeft <= 0) {
      clearInterval(timer);
      if(!answerRevealed) revealAnswer();
      bar.style.display = 'none';
    }
  }, 1000);
}

function filterByDecade(decadePrefix) {
  // In free play, this can filter the available random tracks
  availableTracksForSession = !decadePrefix ? [...allTracks] : allTracks.filter(t => t.year.startsWith(decadePrefix));
  document.getElementById('decadeSelect').value = decadePrefix;
  alert('Decade filter applied for Free Play mode.');
}

document.addEventListener('keydown', function(event) {
    if (document.activeElement === document.getElementById('yearGuess') && event.key === 'Enter') {
        event.preventDefault();
        if (!answerRevealed) revealAnswer();
    }
});
</script>

<footer style="font-size: 0.8em; text-align: center; margin-top: 2em; color: #ccc;">
  <a href="https://github.com/Gignac77" target="_blank" rel="noopener noreferrer" style="color: #ccc; text-decoration: none;">
    Built with Love by Matt
  </a>
</footer>
</body>
</html>
