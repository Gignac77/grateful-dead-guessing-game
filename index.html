<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Guess the Dead Year</title>
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Comic Neue', cursive;
      text-align: center;
      padding: 2em;
      background: url('https://cdn.mos.cms.futurecdn.net/HuGGeENt6kGyixe3hT9tnY.jpg');
      background-color: #111;
      color: #eee;
      margin: 0;
    }
    .card {
      background: rgba(0, 0, 0, 0.8);
      padding: 2em;
      border-radius: 1em;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      max-width: 600px;
      margin: auto;
      width: 90%;
    }
    button, input, select, a {
      font-family: 'Comic Neue', cursive;
      font-weight: bold;
    }
    audio {
      width: 100%;
      margin: 1em 0;
      border: none;
    }
    button {
      padding: 0.6em 1.2em;
      font-size: 1.2em;
      color: white;
      border: none;
      border-radius: 0.5em;
      margin-top: 1em;
      cursor: pointer;
    }
    .generate { background-color: #28a745; width: 100px; height: 100px; border-radius: 50%; }
    .reveal { background-color: #0066cc; }
    .timed { background-color: #9933cc; font-size: 1em; padding: 0.4em 1em; }
    .donate { margin-top: 2em; background-color: #d63384; color: yellow; text-decoration: none; padding: 0.5em 1.5em; border-radius: 0.5em; }
    .share { margin-top: 1em; background-color: #4444aa; color: white; text-decoration: none; padding: 0.4em 1em; border-radius: 0.5em; font-size: 0.9em; display: inline-block; }
    input {
      font-size: 1em;
      padding: 0.5em;
      border-radius: 0.3em;
      border: 1px solid #ccc;
      background-color: white;
      color: black;
      text-align: center;
      width: 6em;
      margin-top: 1em;
    }
    #result {
      margin-top: 1em;
      font-weight: bold;
      font-size: 1.5em;
      white-space: pre-line;
      min-height: 3em;
    }
    .correct { color: #00ff88; animation: glow 1.5s ease-out; }
    .incorrect { color: #ff4444; }
    .neutral { color: yellow; }
    #score {
      margin-top: 1em;
      font-size: 1.2em;
      color: #fff;
      background-color: rgba(255,255,255,0.1);
      border: 1px solid #eee;
      padding: 1em;
      border-radius: 1em;
    }
    #thankYou { margin-top: 0.5em; color: white; font-style: italic; }
    #timerBar {
      width: 100%;
      height: 10px;
      background: linear-gradient(to right, #00ff88, #ff0000);
      transition: width 1s linear;
      margin-top: 1em;
      border-radius: 1em;
      display: none;
    }
    #globalHigh { font-size: 0.9em; margin-top: 0.5em; color: #bbb; }
    #shareTrackLink { font-size: 0.9em; display: none; margin-top: 0.5em; color: #aaa; text-decoration: underline; cursor: pointer; }
    @keyframes glow {
      0% { text-shadow: 0 0 5px #00ff88; }
      50% { text-shadow: 0 0 20px #00ff88; }
      100% { text-shadow: 0 0 5px #00ff88; }
    }
    select {
      margin-top: 1em;
      padding: 0.4em;
      font-size: 1em;
    }
  </style>
</head>
<body>
<div class="card">
  <div style="display: flex; justify-content: space-between; align-items: center; width: 100%;">
    <span style="font-size: 2.2em; color: #228B22;">âš¡ðŸ’€</span>
    <h1 style="font-size: 2.4em; color: yellow; margin: 0; font-weight: 900;">Guess the Dead Year</h1>
    <span style="font-size: 2.2em; color: #228B22;">ðŸ’€âš¡</span>
  </div>
  <p style="font-style: italic; margin-top: 0.5em; font-size: 0.9em;">1965â€“1995</p>

  <audio id="audio" controls></audio>
  <button class="generate" onclick="loadRandomTrack()">Go</button>
  <input type="text" id="yearGuess" placeholder="Year" maxlength="4" autocomplete="off" />
  <button class="reveal" onclick="revealAnswer()">Reveal Answer</button>
  <button class="timed" onclick="toggleTimedMode(this)">Timed Mode</button>
  <div id="timerBar"></div>

  <select id="decadeSelect" onchange="filterByDecade(this.value)">
    <option value="">All Decades</option>
    <option value="196">1960s</option>
    <option value="197">1970s</option>
    <option value="198">1980s</option>
    <option value="199">1990s</option>
  </select>

  <p id="result" class="neutral"></p>
  <p id="score">Score: 0/0 | High Score: 0 | Streak: 0</p>
  <p id="globalHigh">All-Time Score: Matt - 18/20</p>
  <p id="shareTrackLink" onclick="shareCurrentTrack()">Challenge a friend with this song?</p>

  <a href="https://www.gofundme.com/f/our-friend-betty-cantorjackson-could-use-our-help" target="_blank" class="donate">ðŸŒ¸ Donate to Betty</a>
  <a class="share" href="#" onclick="copyShareLink()">ðŸ”— Share This With a Friend</a>
  <p id="thankYou">Thank a Taper</p>
</div>

<script>
let currentTrack = null;
let totalAttempts = 0;
let correctAttempts = 0;
let streak = 0;
let siteHighScore = parseInt(localStorage.getItem('gd_site_highscore')) || 0;
let allTracks = [], filteredTracks = [], guessStats = {};
let timedMode = false, timer = null, timeLeft = 20, answerRevealed = false;

async function loadTracksJson() {
  const res = await fetch('tracks.json');
  allTracks = await res.json();
  filteredTracks = [...allTracks];
}
loadTracksJson();

function getRandomTrack() {
  const index = Math.floor(Math.random() * filteredTracks.length);
  return filteredTracks[index];
}

function loadRandomTrack() {
  const track = getRandomTrack();
  currentTrack = track;
  answerRevealed = false;
  document.getElementById('audio').src = `audio/${track.filename}`;
  document.getElementById('audio').load();
  document.getElementById('audio').play();
  document.getElementById('result').textContent = '';
  document.getElementById('result').className = 'neutral';
  document.getElementById('yearGuess').value = '';
  document.getElementById('shareTrackLink').style.display = 'none';
  if (timedMode) startTimer();
}

function toggleTimedMode(btn) {
  timedMode = !timedMode;
  btn.textContent = timedMode ? 'Timed Mode (On)' : 'Timed Mode';
  btn.style.opacity = timedMode ? '1' : '0.6';
}

function startTimer() {
  clearInterval(timer);
  timeLeft = 20;
  const bar = document.getElementById('timerBar');
  bar.style.display = 'block';
  bar.style.width = '100%';
  timer = setInterval(() => {
    timeLeft--;
    bar.style.width = `${(timeLeft / 20) * 100}%`;
    if (timeLeft <= 0) {
      clearInterval(timer);
      revealAnswer();
      bar.style.display = 'none';
    }
  }, 1000);
}

function filterByDecade(prefix) {
  filteredTracks = prefix ? allTracks.filter(t => t.year.startsWith(prefix)) : [...allTracks];
}

function revealAnswer() {
  if (!currentTrack || answerRevealed) return;
  answerRevealed = true;
  clearInterval(timer);
  document.getElementById('timerBar').style.display = 'none';

  let guess = document.getElementById('yearGuess').value.trim();
  if (/^\d{2}$/.test(guess)) guess = (parseInt(guess) >= 30 ? '19' : '20') + guess;

  const correctYear = currentTrack.year;
  const info = `${currentTrack.track}\nDate: ${currentTrack.date}\n${currentTrack.venue || ''}, ${currentTrack.location || ''}`;

  totalAttempts++;
  let correct = guess === correctYear;
  if (correct) { correctAttempts++; streak++; }
  else { streak = 0; }

  const resultEl = document.getElementById('result');
  resultEl.className = correct ? 'correct' : 'incorrect';
  resultEl.textContent = `${correct ? 'Correct!' : 'Not Quite!'}\nYou guessed: ${guess} â€” Correct Year: ${correctYear}\n\n${info}`;

  const key = currentTrack.filename;
  guessStats[key] = guessStats[key] || { correct: 0, total: 0 };
  guessStats[key].total++;
  if (correct) guessStats[key].correct++;
  if (guessStats[key].total >= 5) {
    const rate = Math.round((guessStats[key].correct / guessStats[key].total) * 100);
    resultEl.textContent += `\n\nThis song has a ${rate}% Guess Success Rate`;
  }

  document.getElementById('shareTrackLink').style.display = 'inline-block';
  updateScore();
}

function updateScore() {
  const scoreEl = document.getElementById('score');
  scoreEl.textContent = `Score: ${correctAttempts}/${totalAttempts} | High Score: ${siteHighScore} | Streak: ${streak}`;
  if (correctAttempts > siteHighScore) {
    siteHighScore = correctAttempts;
    localStorage.setItem('gd_site_highscore', siteHighScore);
  }
}

function copyShareLink() {
  navigator.clipboard.writeText(window.location.href).then(() => alert('Link copied to clipboard!'));
}

function shareCurrentTrack() {
  if (!currentTrack) return;
  alert('Copy and paste this challenge link manually: https://gignac77.github.io/grateful-dead-guessing-game/?track=' + encodeURIComponent(currentTrack.filename));
}
</script>

<footer style="font-size: 0.8em; text-align: center; margin-top: 2em; color: #ccc;">
  <a href="https://github.com/Gignac77" target="_blank" rel="noopener noreferrer" style="color: #ccc; text-decoration: none;">
    Built with Love by Matt - 7/2/25
  </a>
</footer>
</body>
</html>
