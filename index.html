<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DeadGuessr</title>
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Comic Neue', cursive;
      text-align: center;
      padding: 2em;
      background: url('https://cdn.mos.cms.futurecdn.net/HuGGeENt6kGyixe3hT9tnY.jpg');
      background-color: #111;
      color: #eee;
      margin: 0;
    }
    .card {
      background: rgba(0, 0, 0, 0.85);
      padding: 2em;
      border-radius: 1em;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      max-width: 600px;
      margin: auto;
      width: 90%;
      position: relative;
    }
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }
    .header-container h1 {
        font-size: clamp(2.4em, 10vw, 3.8em);
        color: yellow;
        margin: 0;
        font-weight: 900;
        flex-grow: 1;
    }
    /* Bolding the title */
    .header-container h1 strong {
        font-weight: bold;
    }
    .header-container span {
        font-size: 2.2em;
        color: #228B22;
    }
    audio {
      width: 100%;
      margin: 1em 0;
      border: none;
    }
    button {
      padding: 0.6em 1.2em;
      font-size: 1.2em;
      color: white;
      border: none;
      border-radius: 0.5em;
      margin-top: 1em;
      cursor: pointer;
      font-family: 'Comic Neue', cursive;
      font-weight: bold;
      transition: background-color 0.3s, opacity 0.3s;
    }
    button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    .generate {
      background-color: #28a745;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      font-size: 1.2em;
      animation: pulse 1.5s infinite;
    }
    .reveal {
      background-color: #0066cc;
    }
    .timed {
      background-color: #9933cc;
      font-size: 1em;
      padding: 0.4em 1em;
      opacity: 0.6;
    }
    .timed.active {
      opacity: 1;
    }
    .donate {
      display: inline-block;
      margin-top: 2em;
      background-color: #d63384;
      color: yellow;
      text-decoration: none;
      font-weight: bold;
      font-size: 1em;
      padding: 0.5em 1.5em;
      border-radius: 0.5em;
      font-family: 'Comic Neue', cursive;
    }
    .share {
      display: inline-block;
      margin-top: 1em;
      background-color: #4444aa;
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 0.9em;
      padding: 0.4em 1em;
      border-radius: 0.5em;
      font-family: 'Comic Neue', cursive;
    }
    input {
      font-size: 1em;
      padding: 0.5em;
      border-radius: 0.3em;
      border: 1px solid #ccc;
      margin-top: 1em;
      background-color: white;
      color: black;
      text-align: center;
      font-weight: bold;
      width: 6em;
      font-family: 'Comic Neue', cursive;
    }
    #result {
      margin-top: 1em;
      font-weight: bold;
      font-size: 1.5em;
      white-space: pre-line;
      min-height: 3em;
    }
    .correct {
      color: #00ff88;
      animation: glow 1.5s ease-out;
    }
    .incorrect {
      color: #ff4444;
    }
    .neutral {
      color: yellow;
    }
    #score {
      margin-top: 1em;
      font-size: 1.2em;
      color: #fff;
      background-color: rgba(255,255,255,0.1);
      border: 1px solid #eee;
      padding: 1em;
      border-radius: 1em;
    }
    #thankYou {
      margin-top: 0.5em;
      color: white;
      font-style: italic;
    }
    #timerBar {
      width: 100%;
      height: 10px;
      background: linear-gradient(to right, #00ff88, #ff0000);
      transition: width 1s linear;
      margin-top: 1em;
      border-radius: 1em;
      display: none;
    }
    @keyframes glow {
      0% { text-shadow: 0 0 5px #00ff88; }
      50% { text-shadow: 0 0 20px #00ff88; }
      100% { text-shadow: 0 0 5px #00ff88; }
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
      100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
    select {
      margin-top: 1em;
      padding: 0.4em;
      font-size: 1em;
      font-family: 'Comic Neue', cursive;
    }
    #gameModeIndicator {
        font-size: 1.1em;
        margin-top: 1em;
        color: #ffc107;
        font-weight: bold;
    }
    #dailySummaryModal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7);
        backdrop-filter: blur(5px);
    }
    .modal-content {
        background-color: #1a1a1a;
        margin: 10% auto;
        padding: 25px;
        border: 1px solid #888;
        width: 90%;
        max-width: 500px;
        border-radius: 1em;
        text-align: center;
        color: #fff;
    }
    #summaryGraphic {
        font-size: 2em;
        letter-spacing: 0.2em;
        margin: 1em 0;
    }
    #summaryDetails {
        text-align: left;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
        padding-right: 10px;
        margin-bottom: 1.5em;
    }
    .modal-button {
        background-color: #17a2b8;
    }
    .modal-button.continue {
        background-color: #28a745;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header-container">
      <span>⚡💀</span>
      <h1><strong>DeadGuessr</strong></h1>
      <span>💀⚡</span>
    </div>
    <p style="font-style: italic; margin-top: 0.5em; font-size: 0.9em;">1965–1995</p>

    <br />
    <audio id="audio" controls></audio>
    <br />

    <button id="goButton" class="generate" onclick="loadTrack()">Go</button>
    <br />

    <input type="text" id="yearGuess" placeholder="Year" maxlength="4" autocomplete="off" />
    <br />

    <button id="checkButton" class="reveal" onclick="revealAnswer()">Check Answer</button>
    <br />
    <button class="timed" onclick="toggleTimedMode(this)">Timed Mode</button>

    <div id="timerBar"></div>
    
    <div id="gameModeIndicator"></div>

    <select id="decadeSelect" onchange="filterByDecade(this.value)">
      <option value="">All Decades</option>
      <option value="196">1960s</option>
      <option value="197">1970s</option>
      <option value="198">1980s</option>
      <option value="199">1990s</option>
    </select>

    <p id="result" class="neutral"></p>
    <p id="score">Session Score: 0/0 | High Score: 0 | Streak: 0</p>

    <a href="https://www.gofundme.com/f/our-friend-betty-cantorjackson-could-use-our-help" target="_blank" class="donate">🌸 Donate to Betty</a>
    <br />
    <a class="share" href="#" onclick="copyShareLink(event, false)">🔗 Share This Game</a>
    <p id="thankYou">Thank a Taper</p>
  </div>

  <div id="dailySummaryModal">
    <div class="modal-content">
      <h2>Daily Results <span id="summaryDate" style="color: #ffc107;"></span></h2>
      <div id="summaryGraphic"></div>
      <div id="summaryDetails"></div>
      <button class="modal-button" onclick="copyShareLink(event, true)">Share Your Results</button>
      <button class="modal-button continue" onclick="closeSummaryModal()">Continue to Free Play</button>
    </div>
  </div>

<script>
let currentTrack = null;
let totalAttempts = 0;
let correctAttempts = 0;
let streak = 0;
let siteHighScore = parseInt(localStorage.getItem('gd_site_highscore')) || 0;
let allTracks = []; // Stores all tracks loaded from JSON
let filteredTracks = []; // Not explicitly used for free play in this version, available for future use
let availableTracksForSession = []; // Tracks for current free play session, avoiding repeats in a single session
let timedMode = false;
let timer = null;
let timeLeft = 20;
let answerRevealed = false;

// --- DAILY CHALLENGE GLOBAL VARIABLES ---
const MAX_DAILY_GUESSES = 5;
let dailyGuesses = 0; // User's guesses made today
let dailyResults = []; // User's results for today's daily challenge
let todaysDailySongs = []; // The 5 fixed songs for the current day
let inFreePlayMode = false; // Flag to indicate if user is in free play

// --- HELPER FUNCTIONS FOR DAILY CHALLENGE ---

/**
 * Returns today's date in 'YYYY-MM-DD' format (UTC) for consistent seeding.
 */
function getTodayString() {
    const now = new Date();
    // Using UTC to ensure everyone globally gets the same date and thus the same daily songs.
    return now.getUTCFullYear() + '-' +
           String(now.getUTCMonth() + 1).padStart(2, '0') + '-' +
           String(now.getUTCDate()).padStart(2, '0');
}

/**
 * Simple pseudo-random number generator for consistent shuffling based on a seed.
 * Source: https://stackoverflow.com/questions/521295/seeding-the-random-number-generator-in-javascript
 */
function mulberry32(seed) {
    return function() {
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t = (t ^ t >>> 7) + (t ^ t >>> 14);
        return ((t >>> 0) / 4294967296);
    }
}

/**
 * Fisher-Yates shuffle with a seedable random function.
 */
function seededShuffle(array, randomFunc) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex != 0) {
        randomIndex = Math.floor(randomFunc() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [
            array[randomIndex], array[currentIndex]];
    }
    return array;
}

// --- CORE GAME LOGIC ---

document.addEventListener('DOMContentLoaded', async () => {
    await loadTracksJson(); // Load all tracks first
    checkDailyStatus(); // Determine game mode and today's 5 songs
    
    // Set initial message based on game mode
    if (!inFreePlayMode) {
        document.getElementById('result').textContent = 'Press "Go" to start your Daily Challenge!';
        document.getElementById('decadeSelect').style.display = 'none'; // Hide decade filter for daily
    } else {
        document.getElementById('result').textContent = 'Daily Challenge complete! Welcome to Free Play.';
        document.getElementById('decadeSelect').style.display = 'block'; // Show decade filter for free play
    }
    // Update score display regardless of mode
    updateScore();
});

async function loadTracksJson() {
    try {
        const res = await fetch('tracks.json');
        allTracks = await res.json();
        // Initialize free play tracks with all tracks initially
        availableTracksForSession = [...allTracks]; 
    } catch (error) {
        console.error('Error loading tracks.json:', error);
        document.getElementById('result').textContent = 'Could not load tracks. Please refresh!';
    }
}

/**
 * Manages the daily song queue and user progress.
 */
function checkDailyStatus() {
    const lastPlayDate = localStorage.getItem('gd_lastPlayDate');
    const today = getTodayString();

    // Determine today's 5 songs first, which might also manage the global queue index
    todaysDailySongs = getTodaysUniversalSongs();

    if (lastPlayDate === today) {
        // User has played today, load their progress
        dailyGuesses = parseInt(localStorage.getItem('gd_dailyGuesses')) || 0;
        dailyResults = JSON.parse(localStorage.getItem('gd_dailyResults')) || [];
        if (dailyGuesses >= MAX_DAILY_GUESSES) {
            inFreePlayMode = true;
            // Filter out daily challenge songs from free play pool for today
            removeDailySongsFromFreePlayPool();
        }
    } else {
        // New day, reset user's daily progress
        localStorage.setItem('gd_lastPlayDate', today);
        localStorage.setItem('gd_dailyGuesses', '0');
        localStorage.setItem('gd_dailyResults', '[]');
        dailyGuesses = 0;
        dailyResults = [];
        inFreePlayMode = false;
        // Reset available tracks for a new free play session
        availableTracksForSession = [...allTracks]; 
    }
    updateGameModeUI();
}

/**
 * Gets the 5 universal songs for today's daily challenge.
 * Manages a global shuffled queue in localStorage that all users draw from.
 */
function getTodaysUniversalSongs() {
    const today = getTodayString();
    // Convert date string to a consistent number for seeding
    const dateSeed = parseInt(today.replace(/-/g, '')); 
    const random = mulberry32(dateSeed); // Get seeded random function for today

    let globalQueue = JSON.parse(localStorage.getItem('gd_globalSongQueue')) || [];
    let globalQueueIndex = parseInt(localStorage.getItem('gd_globalQueueIndex')) || 0;
    let lastQueueShuffleDate = localStorage.getItem('gd_lastQueueShuffleDate');

    // Scenario 1: First time loading or all tracks exhausted, or tracks.json updated
    // Check if globalQueue is empty, or if it doesn't contain all current tracks (new tracks added)
    const currentTrackFilenames = new Set(allTracks.map(t => t.filename));
    const queueFilenames = new Set(globalQueue.map(t => t.filename));
    const missingTracks = [...currentTrackFilenames].filter(f => !queueFilenames.has(f));

    if (globalQueue.length === 0 || globalQueueIndex >= globalQueue.length || missingTracks.length > 0) {
        console.log('Resetting/Updating global song queue due to exhaustion, new tracks, or first load.');
        globalQueue = [...allTracks];
        globalQueue = seededShuffle(globalQueue, random); // Shuffle with today's seed
        localStorage.setItem('gd_globalSongQueue', JSON.stringify(globalQueue));
        globalQueueIndex = 0; // Reset index
        localStorage.setItem('gd_globalQueueIndex', globalQueueIndex.toString());
        localStorage.setItem('gd_lastQueueShuffleDate', today); // Record shuffle date
    } else if (lastQueueShuffleDate !== today) {
        // This logic makes sure the index only advances once per day globally
        // Check if the current queue index would go out of bounds with MAX_DAILY_GUESSES
        // if (globalQueueIndex + MAX_DAILY_GUESSES > globalQueue.length) {
        //     // If advancing would exhaust the list, reshuffle and reset index for next day
        //     console.log('Global queue nearing exhaustion, re-shuffling for next cycle.');
        //     globalQueue = [...allTracks]; // Ensure new tracks are included
        //     globalQueue = seededShuffle(globalQueue, random);
        //     localStorage.setItem('gd_globalSongQueue', JSON.stringify(globalQueue));
        //     globalQueueIndex = 0;
        // } else {
            // Only advance index once per day
            globalQueueIndex = (globalQueueIndex + MAX_DAILY_GUESSES) % globalQueue.length; // Loop back if needed
            // Ensure the index doesn't go beyond the bounds and if it does, wrap it around
            if (globalQueueIndex + MAX_DAILY_GUESSES > globalQueue.length) {
                 globalQueueIndex = 0; // Start from beginning if not enough songs left
                 globalQueue = [...allTracks];
                 globalQueue = seededShuffle(globalQueue, random); // Re-shuffle on cycle end
                 localStorage.setItem('gd_globalSongQueue', JSON.stringify(globalQueue));
                 console.log('Global queue wrapped around and re-shuffled.');
            }
        // }
        localStorage.setItem('gd_globalQueueIndex', globalQueueIndex.toString());
        localStorage.setItem('gd_lastQueueShuffleDate', today); // Update the date for index advance
    }
    
    // Select today's 5 songs from the global queue
    const dailySongs = [];
    for (let i = 0; i < MAX_DAILY_GUESSES; i++) {
        const songIndex = (globalQueueIndex + i) % globalQueue.length;
        dailySongs.push(globalQueue[songIndex]);
    }
    return dailySongs;
}

/**
 * Removes today's daily challenge songs from the available free play pool.
 */
function removeDailySongsFromFreePlayPool() {
    const dailyFilenames = new Set(todaysDailySongs.map(t => t.filename));
    availableTracksForSession = availableTracksForSession.filter(track => !dailyFilenames.has(track.filename));
}

function updateGameModeUI() {
    const indicator = document.getElementById('gameModeIndicator');
    const decadeSelect = document.getElementById('decadeSelect');
    if (inFreePlayMode) {
        indicator.textContent = 'Mode: Free Play';
        decadeSelect.style.display = 'block'; // Show decade filter in free play
    } else {
        const guessesLeft = MAX_DAILY_GUESSES - dailyGuesses;
        indicator.textContent = `Daily Challenge: ${guessesLeft}/${MAX_DAILY_GUESSES} Guesses Left`;
        decadeSelect.style.display = 'none'; // Hide decade filter for daily challenge
    }
}

/**
 * A single function to load the correct track based on game mode.
 */
function loadTrack() {
    let track;
    if (!inFreePlayMode) {
        // Daily Challenge: Load the next song from the fixed daily list
        if (dailyGuesses < MAX_DAILY_GUESSES) {
            track = todaysDailySongs[dailyGuesses];
        } else {
            // This case should ideally be caught by checkDailyStatus
            inFreePlayMode = true;
            updateGameModeUI();
            showDailySummary(); // Show summary if they try to "Go" after exhausting dailies
            return;
        }
    } else {
        // Free Play: Load a random track from the available session pool
        if (availableTracksForSession.length === 0) {
            availableTracksForSession = [...allTracks]; // Re-populate with all tracks
            // Remove daily songs if they just finished the daily challenge and entered free play
            removeDailySongsFromFreePlayPool(); 
            alert("You've played all available songs in Free Play! Starting a new random cycle.");
        }
        const randIndex = Math.floor(Math.random() * availableTracksForSession.length);
        track = availableTracksForSession[randIndex];
        availableTracksForSession.splice(randIndex, 1); // Remove to avoid repeats in session
    }

    if (!track) {
        document.getElementById('result').textContent = 'No more tracks available!';
        return;
    }
    
    currentTrack = track;
    answerRevealed = false;
    document.getElementById('audio').src = `audio/${track.filename}`;
    document.getElementById('audio').load();
    document.getElementById('audio').play().catch(() => {});
    document.getElementById('result').textContent = '';
    document.getElementById('result').className = 'neutral';
    document.getElementById('yearGuess').value = '';
    document.getElementById('checkButton').disabled = false;
    document.getElementById('goButton').textContent = 'Next'; // Change button text after first go

    if (timedMode) startTimer();
}

function revealAnswer() {
    if (!currentTrack || answerRevealed) return;
    answerRevealed = true;
    clearInterval(timer);
    document.getElementById('timerBar').style.display = 'none';
    document.getElementById('checkButton').disabled = true;

    let guess = document.getElementById('yearGuess').value.trim();
    if (/^\d{2}$/.test(guess)) {
        guess = (parseInt(guess, 10) >= 65 ? '19' : '20') + guess;
    }

    const correctYear = currentTrack.year;
    const correct = (guess === correctYear);

    totalAttempts++; // Overall session attempts
    if (correct) {
        correctAttempts++; // Overall session correct
        streak++;
    } else {
        streak = 0;
    }

    if (!inFreePlayMode) {
        // Record result for daily challenge
        dailyResults.push({
            correct: correct,
            guess: guess,
            trackInfo: `${currentTrack.track} (${correctYear})`
        });
        dailyGuesses++; // Increment daily guesses count
        localStorage.setItem('gd_dailyGuesses', dailyGuesses.toString());
        localStorage.setItem('gd_dailyResults', JSON.stringify(dailyResults));

        if (dailyGuesses >= MAX_DAILY_GUESSES) {
            showDailySummary(); // Show summary if daily challenge completed
        }
    }

    if (correctAttempts > siteHighScore) {
        siteHighScore = correctAttempts;
        localStorage.setItem('gd_site_highscore', siteHighScore);
    }

    const resultEl = document.getElementById('result');
    resultEl.className = correct ? 'correct' : 'incorrect';
    resultEl.textContent = `${correct ? 'Correct!' : 'Not Quite!'}\nYou guessed: ${guess} — Correct Year: ${correctYear}\n\nSong: ${currentTrack.track}\nDate: ${currentTrack.date}\n${currentTrack.venue}, ${currentTrack.location}`;
    
    updateScore();
    updateGameModeUI(); // Update UI to reflect daily guesses count
}

function showDailySummary() {
    const modal = document.getElementById('dailySummaryModal');
    document.getElementById('summaryDate').textContent = `(${getTodayString()})`;
    const graphicEl = document.getElementById('summaryGraphic');
    const detailsEl = document.getElementById('summaryDetails');
    
    let graphic = dailyResults.map(r => r.correct ? '🟩' : '🟥').join(' ');
    let details = dailyResults.map((result, index) => 
        `${result.correct ? '✅' : '❌'} Guess ${index + 1}: You guessed ${result.guess || 'No guess'} for ${result.trackInfo}`
    ).join('\n');
    let dailyCorrect = dailyResults.filter(r => r.correct).length;

    graphicEl.textContent = graphic;
    detailsEl.innerHTML = `<strong>Your Score Today: ${dailyCorrect}/${MAX_DAILY_GUESSES}</strong>\n\n${details}`;
    modal.style.display = 'block';
}

function closeSummaryModal() {
    document.getElementById('dailySummaryModal').style.display = 'none';
    inFreePlayMode = true;
    updateGameModeUI();
    document.getElementById('result').textContent = 'Welcome to Free Play! Press "Next" for a random song.';
    document.getElementById('goButton').textContent = 'Next';
    // Ensure daily challenge songs are removed from the free play pool for today
    removeDailySongsFromFreePlayPool(); 
}

function copyShareLink(event, isFromResultModal) {
    event.preventDefault();
    let shareText;
    if (isFromResultModal && dailyResults.length > 0) {
        const graphic = dailyResults.map(r => r.correct ? '🟩' : '🟥').join('');
        const dailyCorrect = dailyResults.filter(r => r.correct).length;
        shareText = `DeadGuessr Daily Challenge ${getTodayString()}\nMy Score: ${dailyCorrect}/${MAX_DAILY_GUESSES}\n${graphic}\n\nPlay here: ${window.location.href}`;
    } else {
        shareText = `Check out this "DeadGuessr" game! \n\n${window.location.href}`;
    }

    navigator.clipboard.writeText(shareText).then(() => {
        alert('Results copied to clipboard!');
    }).catch(err => console.error('Failed to copy: ', err));
}

function updateScore() {
    document.getElementById('score').textContent = `Session Score: ${correctAttempts}/${totalAttempts} | High Score: ${siteHighScore} | Streak: ${streak}`;
}

function toggleTimedMode(btn) {
    timedMode = !timedMode;
    btn.classList.toggle('active', timedMode);
    if (!timedMode) {
        clearInterval(timer);
        document.getElementById('timerBar').style.display = 'none';
    }
}

function startTimer() {
    clearInterval(timer);
    timeLeft = 20;
    const bar = document.getElementById('timerBar');
    bar.style.display = 'block';
    bar.style.width = '100%';

    timer = setInterval(() => {
        timeLeft--;
        bar.style.width = `${(timeLeft / 20) * 100}%`;
        if (timeLeft <= 0) {
            clearInterval(timer);
            if(!answerRevealed) revealAnswer();
            bar.style.display = 'none';
        }
    }, 1000);
}

function filterByDecade(decadePrefix) {
    // Only apply filter if in Free Play mode and after daily challenge has finished for the day
    if (inFreePlayMode) {
        // Reset to all tracks before filtering to ensure new filter is applied correctly
        availableTracksForSession = [...allTracks];
        // Ensure daily challenge songs are still excluded if they were played today
        removeDailySongsFromFreePlayPool();

        if (decadePrefix) {
            availableTracksForSession = availableTracksForSession.filter(t => t.year.startsWith(decadePrefix));
        }
        document.getElementById('decadeSelect').value = decadePrefix;
        alert('Decade filter applied for Free Play mode. Press "Next" to get a song from this decade.');
    } else {
        document.getElementById('decadeSelect').value = ''; // Reset selection if daily mode
        alert('Decade filtering is only available in Free Play mode after completing the daily challenge.');
    }
}

document.addEventListener('keydown', function(event) {
    if (document.activeElement === document.getElementById('yearGuess') && event.key === 'Enter') {
        event.preventDefault();
        if (!answerRevealed) revealAnswer();
    }
});
</script>

<footer style="font-size: 0.8em; text-align: center; margin-top: 2em; color: #ccc;">
  <a href="https://github.com/Gignac77" target="_blank" rel="noopener noreferrer" style="color: #ccc; text-decoration: none;">
    Built with Love by Matt
  </a>
</footer>
</body>
</html>
