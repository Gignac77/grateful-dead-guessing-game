<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>DeadGuessr</title>
  <link href="https://fonts.googleapis.com/css2?family=Comic+Neue&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Comic Neue', cursive;
      text-align: center;
      padding: 2em;
      background: url('https://cdn.mos.cms.futurecdn.net/HuGGeENt6kGyixe3hT9tnY.jpg');
      background-color: #111;
      color: #eee;
      margin: 0;
    }
    .card {
      background: rgba(0, 0, 0, 0.85);
      padding: 2em;
      border-radius: 1em;
      box-shadow: 0 0 20px rgba(255, 255, 255, 0.1);
      max-width: 600px;
      margin: auto;
      width: 90%;
      position: relative;
    }
    .header-container {
      display: flex;
      justify-content: space-between;
      align-items: center;
      width: 100%;
    }
    .header-container h1 {
        font-size: clamp(2.4em, 10vw, 3.8em);
        color: yellow;
        margin: 0;
        font-weight: 900;
        flex-grow: 1;
    }
    /* Bolding the title */
    .header-container h1 strong {
        font-weight: bold;
    }
    .header-container span {
        font-size: 2.2em;
        color: #228B22;
    }
    audio {
      width: 100%;
      margin: 1em 0;
      border: none;
    }
    button {
      padding: 0.6em 1.2em;
      font-size: 1.2em;
      color: white;
      border: none;
      border-radius: 0.5em;
      margin-top: 1em;
      cursor: pointer;
      font-family: 'Comic Neue', cursive;
      font-weight: bold;
      transition: background-color 0.3s, opacity 0.3s;
    }
    button:disabled {
        cursor: not-allowed;
        opacity: 0.5;
    }
    .generate {
      background-color: #28a745;
      width: 100px;
      height: 100px;
      border-radius: 50%;
      font-size: 1.2em;
      animation: pulse 1.5s infinite;
    }
    .reveal {
      background-color: #0066cc;
    }
    .timed {
      background-color: #9933cc;
      font-size: 1em;
      padding: 0.4em 1em;
      opacity: 0.6;
    }
    .timed.active {
      opacity: 1;
    }
    .donate {
      display: inline-block;
      margin-top: 2em;
      background-color: #d63384;
      color: yellow;
      text-decoration: none;
      font-weight: bold;
      font-size: 1em;
      padding: 0.5em 1.5em;
      border-radius: 0.5em;
      font-family: 'Comic Neue', cursive;
    }
    .share {
      display: inline-block;
      margin-top: 1em;
      background-color: #4444aa;
      color: white;
      text-decoration: none;
      font-weight: bold;
      font-size: 0.9em;
      padding: 0.4em 1em;
      border-radius: 0.5em;
      font-family: 'Comic Neue', cursive;
    }
    input {
      font-size: 1em;
      padding: 0.5em;
      border-radius: 0.3em;
      border: 1px solid #ccc;
      margin-top: 1em;
      background-color: white;
      color: black;
      text-align: center;
      font-weight: bold;
      width: 6em;
      font-family: 'Comic Neue', cursive;
    }
    #result {
      margin-top: 1em;
      font-weight: bold;
      font-size: 1.5em;
      white-space: pre-line;
      min-height: 3em;
    }
    .correct {
      color: #00ff88;
      animation: glow 1.5s ease-out;
    }
    .incorrect {
      color: #ff4444;
    }
    .neutral {
      color: yellow;
    }
    #score {
      margin-top: 1em;
      font-size: 1.2em;
      color: #fff;
      background-color: rgba(255,255,255,0.1);
      border: 1px solid #eee;
      padding: 1em;
      border-radius: 1em;
    }
    #thankYou {
      margin-top: 0.5em;
      color: white;
      font-style: italic;
    }
    #timerBar {
      width: 100%;
      height: 10px;
      background: linear-gradient(to right, #00ff88, #ff0000);
      transition: width 1s linear;
      margin-top: 1em;
      border-radius: 1em;
      display: none;
    }
    @keyframes glow {
      0% { text-shadow: 0 0 5px #00ff88; }
      50% { text-shadow: 0 0 20px #00ff88; }
      100% { text-shadow: 0 0 5px #00ff88; }
    }
    @keyframes pulse {
      0% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0.7); }
      70% { box-shadow: 0 0 0 10px rgba(40, 167, 69, 0); }
      100% { box-shadow: 0 0 0 0 rgba(40, 167, 69, 0); }
    }
    select {
      margin-top: 1em;
      padding: 0.4em;
      font-size: 1em;
      font-family: 'Comic Neue', cursive;
      /* Ensure select is centered */
      display: block; 
      margin-left: auto;
      margin-right: auto;
    }
    #gameModeIndicator {
        font-size: 1.1em;
        margin-top: 1em;
        color: #ffc107;
        font-weight: bold;
        /* Hide by default, shown only in daily challenge */
        display: none; 
    }
    /* Styles for Modals */
    .modal {
        display: none;
        position: fixed;
        z-index: 100;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        overflow: auto;
        background-color: rgba(0,0,0,0.7);
        backdrop-filter: blur(5px);
    }
    .modal-content {
        background-color: #1a1a1a;
        margin: 10% auto;
        padding: 25px;
        border: 1px solid #888;
        width: 90%;
        max-width: 500px;
        border-radius: 1em;
        text-align: center;
        color: #fff;
        position: relative; /* For the close button */
    }
    .modal-close {
        color: #aaa;
        float: right;
        font-size: 28px;
        font-weight: bold;
        position: absolute;
        top: 10px;
        right: 20px;
    }
    .modal-close:hover,
    .modal-close:focus {
        color: white;
        text-decoration: none;
        cursor: pointer;
    }
    #summaryGraphic {
        font-size: 2em;
        letter-spacing: 0.2em;
        margin: 1em 0;
    }
    #summaryDetails, #sessionLogContent {
        text-align: left;
        white-space: pre-wrap;
        max-height: 200px;
        overflow-y: auto;
        padding-right: 10px;
        margin-bottom: 1.5em;
        font-size: 0.9em;
    }
    .modal-button {
        background-color: #17a2b8;
    }
    .modal-button.continue {
        background-color: #28a745;
    }
    .session-log-entry {
        border-bottom: 1px dashed rgba(255,255,255,0.2);
        padding: 0.5em 0;
    }
    .session-log-entry:last-child {
        border-bottom: none;
    }
  </style>
</head>
<body>
  <div class="card">
    <div class="header-container">
      <span>‚ö°üíÄ</span>
      <h1><strong>DeadGuessr</strong></h1>
      <span>üíÄ‚ö°</span>
    </div>
    <p style="font-style: italic; margin-top: 0.5em; font-size: 0.9em;">1965‚Äì1995</p>

    <br />
    <audio id="audio" controls></audio>
    <br />

    <button id="goButton" class="generate" onclick="loadTrack()">Go</button>
    <br />

    <input type="text" id="yearGuess" placeholder="Year" maxlength="4" autocomplete="off" />
    <br />

    <button id="checkButton" class="reveal" onclick="revealAnswer()">Check Answer</button>
    <br />
    <button class="timed" onclick="toggleTimedMode(this)">Timed Mode</button>
    <button id="viewDailyResultsButton" class="reveal" style="display: none; margin-top: 0.5em;" onclick="showDailySummary()">View Daily Results</button>
    <button id="viewSessionLogButton" class="reveal" style="margin-top: 0.5em;" onclick="showSessionLog()">View Session Log</button>

    <div id="timerBar"></div>
    
    <div id="gameModeIndicator"></div>

    <select id="decadeSelect" onchange="filterByDecade(this.value)">
      <option value="">All Decades</option>
      <option value="196">1960s</option>
      <option value="197">1970s</option>
      <option value="198">1980s</option>
      <option value="199">1990s</option>
    </select>

    <p id="result" class="neutral"></p>
    <p id="score">Session Score: 0/0 | High Score: 0 | Streak: 0</p>

    <a href="https://www.gofundme.com/f/our-friend-betty-cantorjackson-could-use-our-help" target="_blank" class="donate">üå∏ Donate to Betty</a>
    <br />
    <a class="share" href="#" onclick="copyShareLink(event, false)">üîó Share The Fun</a>
    <p id="thankYou">Thank a Taper</p>
  </div>

  <div id="dailySummaryModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeSummaryModal()">&times;</span>
      <h2>Daily Results <span id="summaryDate" style="color: #ffc107;"></span></h2>
      <div id="summaryGraphic"></div>
      <div id="summaryDetails"></div>
      <button class="modal-button" onclick="copyShareLink(event, true)">Share Your Results</button>
      <button class="modal-button continue" onclick="closeSummaryModal()">Continue to Free Play</button>
    </div>
  </div>

  <div id="sessionLogModal" class="modal">
    <div class="modal-content">
      <span class="modal-close" onclick="closeSessionLogModal()">&times;</span>
      <h2>Session Log</h2>
      <div id="sessionLogContent"></div>
      <button class="modal-button continue" onclick="closeSessionLogModal()">Close</button>
    </div>
  </div>

<script>
let currentTrack = null;
let totalAttempts = 0;
let correctAttempts = 0;
let streak = 0;
let siteHighScore = parseInt(localStorage.getItem('gd_site_highscore')) || 0;
let allTracks = []; 
let availableTracksForSession = []; 
let timedMode = false;
let timer = null;
let timeLeft = 20;
let answerRevealed = false;
let sessionGuesses = []; // Stores data for the session log

// --- DAILY CHALLENGE GLOBAL VARIABLES ---
const MAX_DAILY_GUESSES = 5;
let dailyGuesses = 0; 
let dailyResults = []; 
let todaysDailySongs = []; 
let inFreePlayMode = false; 

// --- HELPER FUNCTIONS FOR DAILY CHALLENGE ---

/**
 * Returns today's date in 'YYYY-MM-DD' format (UTC) for consistent seeding.
 */
function getTodayString() {
    const now = new Date();
    // Using UTC to ensure everyone globally gets the same date and thus the same daily songs.
    return now.getUTCFullYear() + '-' +
           String(now.getUTCMonth() + 1).padStart(2, '0') + '-' +
           String(now.getUTCDate()).padStart(2, '0');
}

/**
 * Returns today's date in a readable format like "July 6th, 2025".
 */
function getFormattedDate(dateString) {
    const date = new Date(dateString + 'T12:00:00Z'); // Add T12:00:00Z to ensure it's treated as UTC midday
    const options = { year: 'numeric', month: 'long', day: 'numeric' };
    return date.toLocaleDateString('en-US', options);
}

/**
 * Simple pseudo-random number generator for consistent shuffling based on a seed.
 * Source: https://stackoverflow.com/questions/521295/seeding-the-random-number-generator-in-javascript
 */
function mulberry32(seed) {
    return function() {
        let t = seed += 0x6D2B79F5;
        t = Math.imul(t ^ t >>> 15, t | 1);
        t = (t ^ t >>> 7) + (t ^ t >>> 14);
        return ((t >>> 0) / 4294967296);
    }
}

/**
 * Fisher-Yates shuffle with a seedable random function.
 */
function seededShuffle(array, randomFunc) {
    let currentIndex = array.length, randomIndex;
    while (currentIndex != 0) {
        randomIndex = Math.floor(randomFunc() * currentIndex);
        currentIndex--;
        [array[currentIndex], array[randomIndex]] = [
            array[randomIndex], array[currentIndex]];
    }
    return array;
}

// --- CORE GAME LOGIC ---

document.addEventListener('DOMContentLoaded', async () => {
    await loadTracksJson(); 
    checkDailyStatus(); 
    
    // Set initial message based on game mode
    if (!inFreePlayMode) {
        document.getElementById('result').textContent = 'Press "Go" to start your Daily Challenge!';
        document.getElementById('decadeSelect').style.display = 'none'; 
        document.getElementById('viewDailyResultsButton').style.display = 'none';
        document.getElementById('gameModeIndicator').style.display = 'block'; // Show indicator for daily challenge
    } else {
        document.getElementById('result').textContent = 'Daily Challenge complete! Welcome to Free Play.';
        document.getElementById('decadeSelect').style.display = 'block'; 
        document.getElementById('viewDailyResultsButton').style.display = 'block'; // Show button in free play
        document.getElementById('gameModeIndicator').style.display = 'none'; // Hide indicator in free play
    }
    updateScore();
});

async function loadTracksJson() {
    try {
        const res = await fetch('tracks.json');
        allTracks = await res.json();
        availableTracksForSession = [...allTracks]; 
    } catch (error) {
        console.error('Error loading tracks.json:', error);
        document.getElementById('result').textContent = 'Could not load tracks. Please refresh!';
    }
}

/**
 * Manages the daily song queue and user progress.
 */
function checkDailyStatus() {
    const lastPlayDate = localStorage.getItem('gd_lastPlayDate');
    const today = getTodayString();

    todaysDailySongs = getTodaysUniversalSongs();

    if (lastPlayDate === today) {
        dailyGuesses = parseInt(localStorage.getItem('gd_dailyGuesses')) || 0;
        dailyResults = JSON.parse(localStorage.getItem('gd_dailyResults')) || [];
        if (dailyGuesses >= MAX_DAILY_GUESSES) {
            inFreePlayMode = true;
            removeDailySongsFromFreePlayPool();
        }
    } else {
        localStorage.setItem('gd_lastPlayDate', today);
        localStorage.setItem('gd_dailyGuesses', '0');
        localStorage.setItem('gd_dailyResults', '[]');
        dailyGuesses = 0;
        dailyResults = [];
        inFreePlayMode = false;
        availableTracksForSession = [...allTracks]; 
    }
    updateGameModeUI();
}

/**
 * Gets the 5 universal songs for today's daily challenge.
 * Manages a global shuffled queue in localStorage that all users draw from.
 */
function getTodaysUniversalSongs() {
    const today = getTodayString();
    const dateSeed = parseInt(today.replace(/-/g, '')); 
    const random = mulberry32(dateSeed); 

    let globalQueue = JSON.parse(localStorage.getItem('gd_globalSongQueue')) || [];
    let globalQueueIndex = parseInt(localStorage.getItem('gd_globalQueueIndex')) || 0;
    let lastQueueShuffleDate = localStorage.getItem('gd_lastQueueShuffleDate');

    const currentTrackFilenames = new Set(allTracks.map(t => t.filename));
    const queueFilenames = new Set(globalQueue.map(t => t.filename));
    const missingTracks = [...currentTrackFilenames].filter(f => !queueFilenames.has(f));

    if (globalQueue.length === 0 || globalQueueIndex >= globalQueue.length || missingTracks.length > 0 || lastQueueShuffleDate !== today) {
        // Condition for reshuffle and index reset:
        // 1. Global queue is empty (first load).
        // 2. Global queue index has gone past the end (all songs played).
        // 3. New tracks have been added to tracks.json (missingTracks > 0).
        // 4. It's a new day, and we need to advance the index and potentially wrap/reshuffle.
        
        console.log('Resetting/Updating global song queue due to exhaustion, new tracks, or new day.');
        globalQueue = [...allTracks]; // Always start with all current tracks
        globalQueue = seededShuffle(globalQueue, random); // Shuffle with today's seed
        
        // If it's a new day, advance the index from yesterday's position
        if (lastQueueShuffleDate !== today) {
            let previousIndex = parseInt(localStorage.getItem('gd_globalQueueIndex')) || 0;
            globalQueueIndex = (previousIndex + MAX_DAILY_GUESSES);
            
            // If the advanced index goes beyond the new shuffled array, reset to 0
            if (globalQueueIndex >= globalQueue.length) {
                globalQueueIndex = 0;
            }
        } else {
            // If it's not a new day, but we're here due to exhaustion or new tracks, reset index to 0
            globalQueueIndex = 0;
        }

        localStorage.setItem('gd_globalSongQueue', JSON.stringify(globalQueue));
        localStorage.setItem('gd_globalQueueIndex', globalQueueIndex.toString());
        localStorage.setItem('gd_lastQueueShuffleDate', today); 
    }
    
    // Select today's 5 songs from the global queue
    const dailySongs = [];
    for (let i = 0; i < MAX_DAILY_GUESSES; i++) {
        const songIndex = (globalQueueIndex + i) % globalQueue.length; // Use modulo for wrapping within current globalQueue
        dailySongs.push(globalQueue[songIndex]);
    }
    return dailySongs;
}


/**
 * Removes today's daily challenge songs from the available free play pool.
 */
function removeDailySongsFromFreePlayPool() {
    const dailyFilenames = new Set(todaysDailySongs.map(t => t.filename));
    availableTracksForSession = availableTracksForSession.filter(track => !dailyFilenames.has(track.filename));
}

function updateGameModeUI() {
    const indicator = document.getElementById('gameModeIndicator');
    const decadeSelect = document.getElementById('decadeSelect');
    const viewDailyResultsBtn = document.getElementById('viewDailyResultsButton');

    if (inFreePlayMode) {
        indicator.style.display = 'none'; // Hide indicator
        decadeSelect.style.display = 'block'; 
        // Only show "View Daily Results" button if user has completed dailies today
        viewDailyResultsBtn.style.display = (dailyGuesses >= MAX_DAILY_GUESSES) ? 'block' : 'none'; 
    } else {
        const guessesLeft = MAX_DAILY_GUESSES - dailyGuesses;
        indicator.textContent = `Daily Challenge: ${guessesLeft}/${MAX_DAILY_GUESSES} Guesses Left`;
        indicator.style.display = 'block'; // Show indicator for daily challenge
        decadeSelect.style.display = 'none'; 
        viewDailyResultsBtn.style.display = 'none'; // Hide in daily challenge mode
    }
}

/**
 * A single function to load the correct track based on game mode.
 */
function loadTrack() {
    let track;
    if (!inFreePlayMode) {
        // Daily Challenge: Load the next song from the fixed daily list
        if (dailyGuesses < MAX_DAILY_GUESSES) {
            track = todaysDailySongs[dailyGuesses];
        } else {
            inFreePlayMode = true;
            updateGameModeUI();
            showDailySummary(); 
            return;
        }
    } else {
        // Free Play: Load a random track from the available session pool
        if (availableTracksForSession.length === 0) {
            availableTracksForSession = [...allTracks]; 
            removeDailySongsFromFreePlayPool(); 
            alert("You've played all available songs in Free Play! Starting a new random cycle.");
        }
        const randIndex = Math.floor(Math.random() * availableTracksForSession.length);
        track = availableTracksForSession[randIndex];
        availableTracksForSession.splice(randIndex, 1); 
    }

    if (!track) {
        document.getElementById('result').textContent = 'No more tracks available!';
        return;
    }
    
    currentTrack = track;
    answerRevealed = false;
    document.getElementById('audio').src = `audio/${track.filename}`;
    document.getElementById('audio').load();
    document.getElementById('audio').play().catch(() => {});
    document.getElementById('result').textContent = '';
    document.getElementById('result').className = 'neutral';
    document.getElementById('yearGuess').value = '';
    document.getElementById('checkButton').disabled = false;
    document.getElementById('goButton').textContent = 'Next'; 

    if (timedMode) startTimer();
}

function revealAnswer() {
    if (!currentTrack || answerRevealed) return;
    answerRevealed = true;
    clearInterval(timer);
    document.getElementById('timerBar').style.display = 'none';
    document.getElementById('checkButton').disabled = true;

    let guess = document.getElementById('yearGuess').value.trim();
    if (/^\d{2}$/.test(guess)) {
        guess = (parseInt(guess, 10) >= 65 ? '19' : '20') + guess;
    }

    const correctYear = currentTrack.year;
    const correct = (guess === correctYear);

    totalAttempts++; 
    if (correct) {
        correctAttempts++; 
        streak++;
    } else {
        streak = 0;
    }

    // Add guess to session log
    sessionGuesses.push({
        track: currentTrack.track,
        correctYear: correctYear,
        guessedYear: guess,
        isCorrect: correct
    });

    if (!inFreePlayMode) {
        dailyResults.push({
            correct: correct,
            guess: guess,
            trackInfo: `${currentTrack.track} (${correctYear})`
        });
        dailyGuesses++; 
        localStorage.setItem('gd_dailyGuesses', dailyGuesses.toString());
        localStorage.setItem('gd_dailyResults', JSON.stringify(dailyResults));

        if (dailyGuesses >= MAX_DAILY_GUESSES) {
            showDailySummary(); 
        }
    }

    if (correctAttempts > siteHighScore) {
        siteHighScore = correctAttempts;
        localStorage.setItem('gd_site_highscore', siteHighScore);
    }

    const resultEl = document.getElementById('result');
    resultEl.className = correct ? 'correct' : 'incorrect';
    resultEl.textContent = `${correct ? 'Correct!' : 'Not Quite!'}\nYou guessed: ${guess} ‚Äî Correct Year: ${correctYear}\n\nSong: ${currentTrack.track}\nDate: ${currentTrack.date}\n${currentTrack.venue}, ${currentTrack.location}`;
    
    updateScore();
    updateGameModeUI(); 
}

function showDailySummary() {
    const modal = document.getElementById('dailySummaryModal');
    document.getElementById('summaryDate').textContent = `(${getFormattedDate(getTodayString())})`;
    const graphicEl = document.getElementById('summaryGraphic');
    const detailsEl = document.getElementById('summaryDetails');
    
    let graphic = dailyResults.map(r => r.correct ? 'üü©' : 'üü•').join(' ');
    let details = dailyResults.map((result, index) => 
        `${result.correct ? '‚úÖ' : '‚ùå'} Guess ${index + 1}: You guessed ${result.guess || 'No guess'} for ${result.trackInfo}`
    ).join('\n');
    let dailyCorrect = dailyResults.filter(r => r.correct).length;

    graphicEl.textContent = graphic;
    detailsEl.innerHTML = `<strong>Your Score Today: ${dailyCorrect}/${MAX_DAILY_GUESSES}</strong>\n\n${details}`;
    modal.style.display = 'block';
}

function closeSummaryModal() {
    document.getElementById('dailySummaryModal').style.display = 'none';
    inFreePlayMode = true;
    updateGameModeUI();
    document.getElementById('result').textContent = 'Welcome to Free Play! Press "Next" for a random song.';
    document.getElementById('goButton').textContent = 'Next';
    removeDailySongsFromFreePlayPool(); 
}

function showSessionLog() {
    const modal = document.getElementById('sessionLogModal');
    const logContent = document.getElementById('sessionLogContent');
    
    if (sessionGuesses.length === 0) {
        logContent.innerHTML = '<p>No guesses made yet this session.</p>';
    } else {
        logContent.innerHTML = sessionGuesses.map((guess, index) => `
            <div class="session-log-entry">
                <strong>Guess ${index + 1}:</strong> ${guess.isCorrect ? '‚úÖ Correct' : '‚ùå Incorrect'}<br>
                <strong>Song:</strong> ${guess.track}<br>
                <strong>Your Guess:</strong> ${guess.guessedYear || 'No guess'}<br>
                <strong>Correct Year:</strong> ${guess.correctYear}
            </div>
        `).join('');
    }
    modal.style.display = 'block';
}

function closeSessionLogModal() {
    document.getElementById('sessionLogModal').style.display = 'none';
}

function copyShareLink(event, isFromResultModal) {
    event.preventDefault();
    let shareText;
    if (isFromResultModal && dailyResults.length > 0) {
        const graphic = dailyResults.map(r => r.correct ? 'üü©' : 'üü•').join('');
        const dailyCorrect = dailyResults.filter(r => r.correct).length;
        shareText = `DeadGuessr Daily Challenge ${getFormattedDate(getTodayString())}\nMy Score: ${dailyCorrect}/${MAX_DAILY_GUESSES}\n${graphic}\n\nPlay here: ${window.location.href}`;
    } else {
        shareText = `Check out this "DeadGuessr" game! \n\n${window.location.href}`;
    }

    navigator.clipboard.writeText(shareText).then(() => {
        alert('Results copied to clipboard!');
    }).catch(err => console.error('Failed to copy: ', err));
}

function updateScore() {
    document.getElementById('score').textContent = `Session Score: ${correctAttempts}/${totalAttempts} | High Score: ${siteHighScore} | Streak: ${streak}`;
}

function toggleTimedMode(btn) {
    timedMode = !timedMode;
    btn.classList.toggle('active', timedMode);
    if (!timedMode) {
        clearInterval(timer);
        document.getElementById('timerBar').style.display = 'none';
    }
}

function startTimer() {
    clearInterval(timer);
    timeLeft = 20;
    const bar = document.getElementById('timerBar');
    bar.style.display = 'block';
    bar.style.width = '100%';

    timer = setInterval(() => {
        timeLeft--;
        bar.style.width = `${(timeLeft / 20) * 100}%`;
        if (timeLeft <= 0) {
            clearInterval(timer);
            if(!answerRevealed) revealAnswer();
            bar.style.display = 'none';
        }
    }, 1000);
}

function filterByDecade(decadePrefix) {
    if (inFreePlayMode) {
        availableTracksForSession = [...allTracks];
        removeDailySongsFromFreePlayPool();

        if (decadePrefix) {
            availableTracksForSession = availableTracksForSession.filter(t => t.year.startsWith(decadePrefix));
        }
        document.getElementById('decadeSelect').value = decadePrefix;
        document.getElementById('result').textContent = `Filter set to ${decadePrefix ? decadePrefix + '0s' : 'All Decades'} for Free Play. Press "Next" to get a song.`;
    } else {
        document.getElementById('decadeSelect').value = ''; 
        alert('Decade filtering is only available in Free Play mode after completing the daily challenge.');
    }
}

document.addEventListener('keydown', function(event) {
    if (document.activeElement === document.getElementById('yearGuess') && event.key === 'Enter') {
        event.preventDefault();
        if (!answerRevealed) revealAnswer();
    }
});
</script>

<footer style="font-size: 0.8em; text-align: center; margin-top: 2em; color: #ccc;">
  <a href="https://github.com/Gignac77" target="_blank" rel="noopener noreferrer" style="color: #ccc; text-decoration: none;">
    Built with Love by Matt
  </a>
</footer>
</body>
</html>
